<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Amharic Autocomplete Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background: #f5f5f5;
    }
    h2 { margin-bottom: 10px; }
    #container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #inputBox {
      width: 100%;
      padding: 12px;
      font-size: 20px;
      border-radius: 8px;
      border: 1px solid #aaa;
    }
    #suggestions {
      margin-top: 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    .suggestion-item {
      padding: 12px;
      cursor: pointer;
      font-size: 18px;
    }
    .suggestion-item:hover {
      background: #eef;
    }
  </style>
</head>

<body>
<div id="container">
  <h2>Amharic Auto-Suggestion</h2>
  <input id="inputBox" type="text" placeholder="Type: kt, ktm, bet, set…">
  <div id="suggestions"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ----------------------------
  // 1. Transliteration Mapping
  // ----------------------------
  const latinToAmharic = {
    "a": "አ", "A": "አ",
    "b": "በ", "B": "በ",
    "f": "ፈ", "F": "ፈ",
    "h": "ሀ", "H": "ሀ",
    "k": "ከ", "K": "ከ",
    "l": "ለ", "L": "ለ",
    "m": "መ", "M": "መ",
    "n": "ነ", "N": "ነ",
    "t": "ተ", "T": "ተ",
    "s": "ሰ", "S": "ሰ",
    "w": "ወ", "W": "ወ",
    "r": "ረ", "R": "ረ"
  };

  // Convert latin "ktm" → "ከተመ"
  function transliterate(str) {
    let am = "";
    for (let ch of str) {
      if (latinToAmharic[ch]) {
        am += latinToAmharic[ch];
      }
    }
    return am;
  }

  // ----------------------------
  // 2. Smart Prefix Adjuster
  // ----------------------------
  function smartPrefix(prefix, roots) {
    if (roots.some(r => r.startsWith(prefix))) return prefix;

    for (let i = prefix.length; i > 0; i--) {
      const shortened = prefix.substring(0, i);
      if (roots.some(r => r.startsWith(shortened))) return shortened;
    }
    return prefix;
  }

  // ----------------------------
  // 3. Load Dictionaries
  // ----------------------------
  let dictionary = [];
  let rootFormsMap = {};

  async function loadDictionary() {
    try {
      const res = await fetch("mobile_dict.json?cache=" + Date.now());
      dictionary = await res.json();
      if (dictionary.words) dictionary = dictionary.words;
      console.log("Dictionary loaded:", dictionary.length);
    } catch (e) {
      console.error("Failed to load dictionary:", e);
    }
  }

  async function loadRootForms() {
    try {
      const res = await fetch("root_forms_map.json?cache=" + Date.now());
      rootFormsMap = await res.json();
      console.log("Root-Forms Map Loaded:", Object.keys(rootFormsMap).length);
    } catch (e) {
      console.error("Failed to load Root-Forms map:", e);
    }
  }

  loadDictionary();
  loadRootForms();

  // ----------------------------
  // 4. Root → Forms Helpers
  // ----------------------------
  function getFormsForRoot(root) {
    return rootFormsMap[root] || [];
  }

  function findMatchingRoots(prefix) {
    return Object.keys(rootFormsMap)
      .filter(root => root.startsWith(prefix));
  }

  // ----------------------------
  // 5. Main Suggestion Function
  // ----------------------------
  function getSuggestions(input) {
    const raw = transliterate(input);
    const rootsList = Object.keys(rootFormsMap);
    const prefix = smartPrefix(raw, rootsList);

    if (!prefix) return [];

    let suggestions = [];
    const roots = findMatchingRoots(prefix);

    roots.forEach(root => {
      suggestions.push(root);
      suggestions.push(...getFormsForRoot(root));
    });

    return [...new Set(suggestions)].slice(0, 25);
  }

  // ----------------------------
  // 6. UI Interaction
  // ----------------------------
  const inputBox = document.getElementById("inputBox");
  const suggestionsBox = document.getElementById("suggestions");

  inputBox.addEventListener("input", () => {
    const val = inputBox.value.trim();
    if (!val) {
      suggestionsBox.style.display = "none";
      return;
    }

    const results = getSuggestions(val);

    if (results.length === 0) {
      suggestionsBox.style.display = "none";
      return;
    }

    renderSuggestions(results);
  });
  function renderSuggestions(list) {
    suggestionsBox.innerHTML = "";
    suggestionsBox.style.display = "block";

    list.forEach(word => {
      const div = document.createElement("div");
      div.className = "suggestion-item";
      div.textContent = word;
      div.onclick = () => {
        inputBox.value = word;
        suggestionsBox.style.display = "none";
      };
      suggestionsBox.appendChild(div);
    });
  }

});
</script>
</body>
</html>

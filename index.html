<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sawasew Amharic Keyboard – PWA Demo</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Sawasew Amharic Keyboard">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').catch(console.error);
}
</script>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 20px;
    max-width: 900px;
    background: #ffffff;
    color: #000;
  }
  body.dark { background: #111; color: #eee; }
  textarea {
    width: 100%; font-size: 24px; padding: 10px; height: 100px; margin-bottom: 12px;
  }
  .keyboard { margin-top: 12px; }
  .row { display: flex; justify-content: center; }
  .key {
    padding: 14px 18px; margin: 3px; background: #f2f2f2;
    border: 1px solid #bbb; border-radius: 6px; font-size: 20px;
    cursor: pointer; user-select: none;
  }
  body.dark .key { background: #333; border-color: #555; color: #eee; }
  #suggestions li {
    display: inline-block; padding: 6px 12px; margin: 4px;
    background: #f4f4f4; border: 1px solid #ccc; border-radius: 6px;
    cursor: pointer; font-size: 22px;
  }
  #predictions li {
    display: inline-block; padding: 6px 12px; margin: 4px;
    background: #dff4ff; border: 1px solid #9ecfff; border-radius: 6px;
    cursor: pointer; font-size: 22px;
  }
  #loading { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
  #spinner {
    width: 18px; height: 18px; border-radius: 50%;
    border: 3px solid #ccc; border-top-color: #007bff;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
  #app { display: none; }
</style>
</head>

<body class="light">
<h1>Sawasew Amharic Keyboard – PWA Demo</h1>

<div id="loading">
  <div id="spinner"></div>
  <div>Loading Amharic dictionary…</div>
</div>

<div id="app">
  <p>Type in English or click the keyboard. Suggestions and prefix–suffix forms appear below.</p>
  <button onclick="toggleTheme()">Toggle Theme</button>

  <textarea id="text" placeholder="Type here or click the keyboard..."></textarea>

  <h3>Suggestions:</h3>
  <ul id="suggestions"></ul>

  <h3>Predictions:</h3>
  <ul id="predictions"></ul>

  <div id="keyboard" class="keyboard"></div>
</div>

<script>
/* ================================================================
   LOAD DICTIONARIES
================================================================ */
let DICT = [];
let NEXT = {};

async function loadData() {
  try {
    const [dictRes, nextRes] = await Promise.all([
      fetch("mobile_dict.json"),
      fetch("next_word_model.json")
    ]);
    DICT = await dictRes.json();
    NEXT = await nextRes.json();
  } catch (e) {
    console.error("Error loading dictionary files:", e);
  } finally {
    document.getElementById("loading").style.display = "none";
    document.getElementById("app").style.display = "block";
    buildKeyboard();
    updateUI();
  }
}

/* ================================================================
   PUNCTUATION CLEANING FUNCTION (NEW)
================================================================ */
function cleanAmharicWord(word) {
  const punct = /[፡።፣፤፥፦፧]/g;
  return word.replace(punct, "").trim();
}

/* ================================================================
   PHONETIC MAP
================================================================ */
const MAP = {
  "tse":"ጸ","tsi":"ጺ","tso":"ጾ","ts":"ጽ","sh":"ሸ","ch":"ቸ","gn":"ኝ",
  "h":"ሀ","l":"ለ","m":"መ","s":"ሰ","z":"ዘ","t":"ተ","n":"ነ","k":"ከ","w":"ወ",
  "b":"በ","f":"ፈ","p":"ፐ","g":"ገ","d":"ደ","j":"ጀ","r":"ረ","q":"ቀ","y":"የ",
  "x":"ሸ","c":"ቸ","a":"አ","e":"እ","i":"ኢ","u":"ኡ","o":"ኦ"
};

function phoneticToAmharic(text) {
  text = text.toLowerCase();
  let out = "", i = 0;
  const keys = Object.keys(MAP).sort((a,b)=>b.length - a.length);
  while (i < text.length) {
    let matched = false;
    for (const k of keys) {
      if (text.startsWith(k, i)) {
        out += MAP[k];
        i += k.length;
        matched = true;
        break;
      }
    }
    if (!matched) {
      if (text[i] === " ") out += " ";
      i++;
    }
  }
  return out;
}

/* ================================================================
   MORPHOLOGY PREFIXES + SUFFIXES
================================================================ */
const PREFIXES = ["በ","ለ","የ","ከ","ብ","ስ"];
const SUFFIXES = [
  "ን","ም","ህ","ዎች","ዎቹ","ዎችን","ዎችም","ዬ","ዎቹም","ዎቹሃም"
];

function applySuffix(root, suffix) {
  if (root.endsWith("ን") && suffix.startsWith("ዎ")) {
    const stem = root.slice(0, -1);

    if (suffix === "ዎች")   return stem + "ኖች";
    if (suffix === "ዎቹ")   return stem + "ኖቹ";
    if (suffix === "ዎችን")  return stem + "ኖችን";
    if (suffix === "ዎችም")  return stem + "ኖችም";
    if (suffix === "ዎቹም")  return stem + "ኖቹም";
    if (suffix === "ዎቹሃም")return stem + "ኖቹሃም";
  }
  return root + suffix;
}

function expandMorphology(root) {
  const out = new Set();
  root = cleanAmharicWord(root);

  out.add(root);
  PREFIXES.forEach(p => out.add(p + root));
  SUFFIXES.forEach(s => out.add(applySuffix(root, s)));

  PREFIXES.forEach(p => {
    SUFFIXES.forEach(s => out.add(p + applySuffix(root, s)));
  });

  return Array.from(out);
}

/* ================================================================
   UPDATED SUGGESTIONS
================================================================ */
function getSuggestions(prefix) {
  if (!prefix || DICT.length === 0) return [];

  prefix = cleanAmharicWord(prefix);

  const baseRoots = DICT
    .filter(e => e.root && e.root.startsWith(prefix))
    .sort((a,b)=> (b.freq||0) - (a.freq||0))
    .slice(0, 5);

  const expanded = new Set();

  baseRoots.forEach(entry => {
    expandMorphology(entry.root).forEach(v => expanded.add(v));
  });

  return Array.from(expanded).slice(0, 20);
}

/* ================================================================
   PREDICTION
================================================================ */
function predictNext(word) {
  word = cleanAmharicWord(word);
  if (!word || !NEXT[word]) return [];
  return NEXT[word].slice(0, 5).map(w => w[0]);
}

/* ================================================================
   UPDATE UI
================================================================ */
function updateUI() {
  const box = document.getElementById("text");
  let raw = box.value.trim().split(/\s+/).pop() || "";

  raw = cleanAmharicWord(raw);  

  const am = phoneticToAmharic(raw);

  const sug = getSuggestions(am);
  document.getElementById("suggestions").innerHTML =
    sug.map(w => `<li onclick="applySuggestion('${w}')">${w}</li>`).join("");
}

function applySuggestion(word) {
  const box = document.getElementById("text");

  let parts = box.value.trim().split(/\s+/);
  parts.pop();
  parts.push(word);

  box.value = parts.join(" ") + " ";

  const pred = predictNext(word);
  document.getElementById("predictions").innerHTML =
    pred.map(w => `<li onclick="insertPred('${w}')">${w}</li>`).join("");
}

function insertPred(word) {
  const box = document.getElementById("text");
  box.value += word + " ";
  updateUI();
}

/* ================================================================
   KEYBOARD
================================================================ */
const rows = [
  ["q","w","e","r","t","y","u","i","o","p"],
  ["a","s","d","f","g","h","j","k","l"],
  ["z","x","c","v","b","n","m","⌫","␣"]
];

function buildKeyboard() {
  const kb = document.getElementById("keyboard");
  kb.innerHTML = "";
  rows.forEach(row => {
    const div = document.createElement("div");
    div.className = "row";
    row.forEach(k => {
      const key = document.createElement("div");
      key.className = "key";
      key.textContent = k;
      key.onclick = () => handleKey(k);
      div.appendChild(key);
    });
    kb.appendChild(div);
  });
}

function handleKey(k) {
  const box = document.getElementById("text");
  if (k === "⌫") box.value = box.value.slice(0, -1);
  else if (k === "␣") box.value += " ";
  else box.value += k;
  updateUI();
}

function toggleTheme() {
  document.body.classList.toggle("dark");
}

loadData();
</script>

</body>
</html>
